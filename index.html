<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cantrav Financial Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --red:#D23931; --navy:#0A2636; --gray:#A2A2A2; --lg:#F0F0F0;
  --grn:#2E8B57; --amb:#E8A317; --wh:#fff;
}
body { font-family:Arial,sans-serif; background:#f5f6f8; min-height:100vh; }
.hdr { background:var(--navy); padding:12px 28px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; box-shadow:0 2px 12px rgba(0,0,0,.15); }
.hdr-left { display:flex; align-items:center; gap:12px; }
.hdr-left img { height:28px; image-rendering:auto; }
.hdr-left .sep { width:1px; height:24px; background:rgba(255,255,255,.2); }
.hdr-left span { font-family:Georgia,serif; font-size:17px; color:#fff; }
.hdr-right { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.hdr-right select { padding:5px 8px; border-radius:6px; border:1px solid rgba(255,255,255,.3); background:rgba(255,255,255,.1); color:#fff; font-size:11px; cursor:pointer; }
.btn { padding:7px 16px; border-radius:6px; border:none; background:var(--red); color:#fff; font-size:12px; cursor:pointer; font-weight:600; }
.btn:hover { opacity:.9; }
.tabs { background:#fff; border-bottom:2px solid var(--lg); padding:0 28px; display:flex; gap:0; overflow-x:auto; }
.tab-btn { padding:11px 20px; border:none; background:none; cursor:pointer; font-size:12px; font-weight:400; color:var(--navy); border-bottom:3px solid transparent; transition:all .2s; white-space:nowrap; }
.tab-btn.active { font-weight:700; color:var(--red); border-bottom-color:var(--red); }
.content { padding:20px 28px; max-width:1400px; margin:0 auto; }
.filters { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:18px; }
.filters label { font-family:Georgia,serif; font-size:12px; color:var(--navy); font-weight:600; }
.filters select { padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:12px; color:var(--navy); min-width:130px; cursor:pointer; }
.filters .clear-btn { padding:6px 12px; border-radius:6px; border:none; background:var(--red); color:#fff; font-size:11px; cursor:pointer; }
.kpi-row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; }
.kpi { background:#fff; border-radius:12px; padding:16px 20px; border-left:4px solid var(--navy); box-shadow:0 2px 8px rgba(10,38,54,.08); flex:1; min-width:180px; }
.kpi-label { font-family:Georgia,serif; font-size:11px; color:var(--gray); text-transform:uppercase; letter-spacing:.5px; margin-bottom:3px; }
.kpi-value { font-size:24px; font-weight:700; color:var(--navy); }
.kpi-sub { font-size:11px; color:var(--gray); margin-top:2px; }
.card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(10,38,54,.08); margin-bottom:20px; }
.card h3 { font-family:Georgia,serif; color:var(--navy); font-size:14px; margin-bottom:14px; }
.chart-row { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:20px; }
.chart-row .card { min-width:300px; }
.chart-row .card.wide { flex:2; }
.chart-row .card.narrow { flex:1; min-width:260px; }
canvas { max-width:100%; }
table { width:100%; border-collapse:collapse; font-size:11px; }
thead tr { border-bottom:2px solid var(--navy); }
th { text-align:left; padding:7px 8px; color:var(--navy); font-weight:700; font-size:10px; text-transform:uppercase; }
td { padding:7px 8px; }
tbody tr { border-bottom:1px solid var(--lg); }
tbody tr:nth-child(even) { background:#f9fafb; }
.badge { padding:3px 9px; border-radius:12px; font-size:10px; font-weight:600; }
.badge-realized { background:#e8f5e9; color:var(--grn); }
.badge-confirmed { background:#fff8e1; color:#f57f17; }
.badge-preliminary { background:#fce4ec; color:var(--red); }
.progress { background:var(--lg); border-radius:8px; height:34px; position:relative; overflow:hidden; }
.progress-seg { position:absolute; top:0; height:100%; transition:width .5s; }
.progress-label { position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:11px; font-weight:700; color:var(--navy); }
.legend-row { display:flex; gap:16px; margin-top:8px; font-size:10px; flex-wrap:wrap; }
.legend-dot { display:inline-block; width:9px; height:9px; border-radius:2px; margin-right:3px; vertical-align:middle; }
.gap-box { border-radius:12px; padding:20px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
.gap-box.red { background:#fff5f5; border:1px solid #ffcdd2; }
.gap-box.green { background:#e8f5e9; border:1px solid #c8e6c9; }
.gap-title { font-family:Georgia,serif; font-size:16px; margin:0; }
.gap-amount { font-size:32px; font-weight:700; }
.upload-zone { border:3px dashed var(--gray); border-radius:16px; padding:60px; text-align:center; background:#fff; cursor:pointer; margin-top:40px; transition:all .3s; }
.upload-zone.dragover { border-color:var(--red); background:rgba(210,57,49,.05); }
.upload-zone h2 { font-family:Georgia,serif; color:var(--navy); font-size:20px; margin-bottom:6px; }
.upload-zone p { color:var(--gray); font-size:12px; margin-bottom:6px; }
.note { background:#fff3cd; border:1px solid #ffc107; border-radius:8px; padding:14px; margin-bottom:14px; font-size:12px; }
.snap-list { display:flex; flex-direction:column; gap:5px; }
.snap-item { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-radius:8px; background:#f9fafb; border:1px solid transparent; }
.snap-item.active { background:rgba(210,57,49,.06); border-color:var(--red); }
.snap-info { display:flex; align-items:center; gap:8px; flex:1; }
.snap-dot { width:6px; height:6px; border-radius:50%; background:var(--red); }
.snap-label { font-size:12px; font-weight:600; color:var(--navy); cursor:pointer; }
.snap-meta { font-size:10px; color:var(--gray); }
.snap-actions { display:flex; gap:5px; }
.snap-actions button { padding:4px 10px; border-radius:4px; font-size:10px; cursor:pointer; }
.snap-load { border:1px solid var(--navy); background:none; color:var(--navy); }
.snap-del { border:1px solid var(--red); background:none; color:var(--red); }
.tab-content { display:none; }
.tab-content.active { display:block; }
#file-input { display:none; }

</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-left">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAAtCAYAAADr0SSvAAAKMWlDQ1BJQ0MgUHJvZmlsZQAAeJydlndUU9kWh8+9N71QkhCKlNBraFICSA29SJEuKjEJEErAkAAiNkRUcERRkaYIMijggKNDkbEiioUBUbHrBBlE1HFwFBuWSWStGd+8ee/Nm98f935rn73P3Wfvfda6AJD8gwXCTFgJgAyhWBTh58WIjYtnYAcBDPAAA2wA4HCzs0IW+EYCmQJ82IxsmRP4F726DiD5+yrTP4zBAP+flLlZIjEAUJiM5/L42VwZF8k4PVecJbdPyZi2NE3OMErOIlmCMlaTc/IsW3z2mWUPOfMyhDwZy3PO4mXw5Nwn4405Er6MkWAZF+cI+LkyviZjg3RJhkDGb+SxGXxONgAoktwu5nNTZGwtY5IoMoIt43kA4EjJX/DSL1jMzxPLD8XOzFouEiSniBkmXFOGjZMTi+HPz03ni8XMMA43jSPiMdiZGVkc4XIAZs/8WRR5bRmyIjvYODk4MG0tbb4o1H9d/JuS93aWXoR/7hlEH/jD9ld+mQ0AsKZltdn6h21pFQBd6wFQu/2HzWAvAIqyvnUOfXEeunxeUsTiLGcrq9zcXEsBn2spL+jv+p8Of0NffM9Svt3v5WF485M4knQxQ143bmZ6pkTEyM7icPkM5p+H+B8H/nUeFhH8JL6IL5RFRMumTCBMlrVbyBOIBZlChkD4n5r4D8P+pNm5lona+BHQllgCpSEaQH4eACgqESAJe2Qr0O99C8ZHA/nNi9GZmJ37z4L+fVe4TP7IFiR/jmNHRDK4ElHO7Jr8WgI0IABFQAPqQBvoAxPABLbAEbgAD+ADAkEoiARxYDHgghSQAUQgFxSAtaAYlIKtYCeoBnWgETSDNnAYdIFj4DQ4By6By2AE3AFSMA6egCnwCsxAEISFyBAVUod0IEPIHLKFWJAb5AMFQxFQHJQIJUNCSAIVQOugUqgcqobqoWboW+godBq6AA1Dt6BRaBL6FXoHIzAJpsFasBFsBbNgTzgIjoQXwcnwMjgfLoK3wJVwA3wQ7oRPw5fgEVgKP4GnEYAQETqiizARFsJGQpF4JAkRIauQEqQCaUDakB6kH7mKSJGnyFsUBkVFMVBMlAvKHxWF4qKWoVahNqOqUQdQnag+1FXUKGoK9RFNRmuizdHO6AB0LDoZnYsuRlegm9Ad6LPoEfQ4+hUGg6FjjDGOGH9MHCYVswKzGbMb0445hRnGjGGmsVisOtYc64oNxXKwYmwxtgp7EHsSewU7jn2DI+J0cLY4X1w8TogrxFXgWnAncFdwE7gZvBLeEO+MD8Xz8MvxZfhGfA9+CD+OnyEoE4wJroRIQiphLaGS0EY4S7hLeEEkEvWITsRwooC4hlhJPEQ8TxwlviVRSGYkNimBJCFtIe0nnSLdIr0gk8lGZA9yPFlM3kJuJp8h3ye/UaAqWCoEKPAUVivUKHQqXFF4pohXNFT0VFysmK9YoXhEcUjxqRJeyUiJrcRRWqVUo3RU6YbStDJV2UY5VDlDebNyi/IF5UcULMWI4kPhUYoo+yhnKGNUhKpPZVO51HXURupZ6jgNQzOmBdBSaaW0b2iDtCkVioqdSrRKnkqNynEVKR2hG9ED6On0Mvph+nX6O1UtVU9Vvuom1TbVK6qv1eaoeajx1UrU2tVG1N6pM9R91NPUt6l3qd/TQGmYaYRr5Grs0Tir8XQObY7LHO6ckjmH59zWhDXNNCM0V2ju0xzQnNbS1vLTytKq0jqj9VSbru2hnaq9Q/uE9qQOVcdNR6CzQ+ekzmOGCsOTkc6oZPQxpnQ1df11Jbr1uoO6M3rGelF6hXrtevf0Cfos/ST9Hfq9+lMGOgYhBgUGrQa3DfGGLMMUw12G/YavjYyNYow2GHUZPTJWMw4wzjduNb5rQjZxN1lm0mByzRRjyjJNM91tetkMNrM3SzGrMRsyh80dzAXmu82HLdAWThZCiwaLG0wS05OZw2xljlrSLYMtCy27LJ9ZGVjFW22z6rf6aG1vnW7daH3HhmITaFNo02Pzq62ZLde2xvbaXPJc37mr53bPfW5nbse322N3055qH2K/wb7X/oODo4PIoc1h0tHAMdGx1vEGi8YKY21mnXdCO3k5rXY65vTW2cFZ7HzY+RcXpkuaS4vLo3nG8/jzGueNueq5clzrXaVuDLdEt71uUnddd457g/sDD30PnkeTx4SnqWeq50HPZ17WXiKvDq/XbGf2SvYpb8Tbz7vEe9CH4hPlU+1z31fPN9m31XfKz95vhd8pf7R/kP82/xsBWgHcgOaAqUDHwJWBfUGkoAVB1UEPgs2CRcE9IXBIYMj2kLvzDecL53eFgtCA0O2h98KMw5aFfR+OCQ8Lrwl/GGETURDRv4C6YMmClgWvIr0iyyLvRJlESaJ6oxWjE6Kbo1/HeMeUx0hjrWJXxl6K04gTxHXHY+Oj45vipxf6LNy5cDzBPqE44foi40V5iy4s1licvvj4EsUlnCVHEtGJMYktie85oZwGzvTSgKW1S6e4bO4u7hOeB28Hb5Lvyi/nTyS5JpUnPUp2Td6ePJninlKR8lTAFlQLnqf6p9alvk4LTduf9ik9Jr09A5eRmHFUSBGmCfsytTPzMoezzLOKs6TLnJftXDYlChI1ZUPZi7K7xTTZz9SAxESyXjKa45ZTk/MmNzr3SJ5ynjBvYLnZ8k3LJ/J9879egVrBXdFboFuwtmB0pefK+lXQqqWrelfrry5aPb7Gb82BtYS1aWt/KLQuLC98uS5mXU+RVtGaorH1futbixWKRcU3NrhsqNuI2ijYOLhp7qaqTR9LeCUXS61LK0rfb+ZuvviVzVeVX33akrRlsMyhbM9WzFbh1uvb3LcdKFcuzy8f2x6yvXMHY0fJjpc7l+y8UGFXUbeLsEuyS1oZXNldZVC1tep9dUr1SI1XTXutZu2m2te7ebuv7PHY01anVVda926vYO/Ner/6zgajhop9mH05+x42Rjf2f836urlJo6m06cN+4X7pgYgDfc2Ozc0tmi1lrXCrpHXyYMLBy994f9Pdxmyrb6e3lx4ChySHHn+b+O31w0GHe4+wjrR9Z/hdbQe1o6QT6lzeOdWV0iXtjusePhp4tLfHpafje8vv9x/TPVZzXOV42QnCiaITn07mn5w+lXXq6enk02O9S3rvnIk9c60vvG/wbNDZ8+d8z53p9+w/ed71/LELzheOXmRd7LrkcKlzwH6g4wf7HzoGHQY7hxyHui87Xe4Znjd84or7ldNXva+euxZw7dLI/JHh61HXb95IuCG9ybv56Fb6ree3c27P3FlzF3235J7SvYr7mvcbfjT9sV3qID0+6j068GDBgztj3LEnP2X/9H686CH5YcWEzkTzI9tHxyZ9Jy8/Xvh4/EnWk5mnxT8r/1z7zOTZd794/DIwFTs1/lz0/NOvm1+ov9j/0u5l73TY9P1XGa9mXpe8UX9z4C3rbf+7mHcTM7nvse8rP5h+6PkY9PHup4xPn34D94Tz+6TMXDkAABXnSURBVHic7V13fFRV9v/e+96bPpMy6fQqIKIiouCy6M8C6lpQQRcRVAQLy7qoiw1BBMtaUWF1LcsqxS6LCyoaXRXRxS4LqCQBgSSQnkwv773z++NNhiQzb2YSEkB3vp9P/pn33rnnlnPPufeUAGn8IlC98gUqu+5qOtx8/K+BHW4G0tCHv6yUGtavRVPxewiUlsDQsxeOfvff6Tk7hBAPNwNpxKJp40dUv+YNlFw+EYqrCdxqBbfZwAyGw83a/xzSAnIEoWb1i1T/r7XYNftakKpCsNogZmeDiEDBIEBpC+tQIy0gRwBqXl5F+596AuX33QNmkMCtNjDGQIoCUhSApa2qw4W0gBwB8Hz1BcLVVTDkFUCVw4CqIq0rjgzww81AGgC3WMAkCaTIgKoebnbSaIG0gBwJUNX0+eIIRVpA0kgjAdICkkYaCZAWkDTSSIC0gKSRRgKkBSSNNBKgQ34Q79bvSW5sglxTDTEnFxljxrbyZDV9/G9SgwEYunWH9ehj2uXl8v24nYJ794BJEjJPPT3ut+4vN5NcUwMiFWJmFhynjDlsnjTfj9spXLUfaiAAbrHAUFAI84CjfrWePe/331Jo/z5wqxUZvxnbrn56t3xL4ZpakCJDcDjgOPmUI36cUmaw6u/PkPuzTxHYWQbV60G4phqWY45FjwWLYRs+ggFA+V8WU8O6tVBcTSAicIMB5sFHo+jm22A7bnjCtnw/bKOKh+6Db8v3UENBMDAIdgcyzhqPngsWR7/d+cfrqPGd9eAWC0iRwQQRgs0GU/+ByDrnPORcOjnlPvlLdhAEDl2vHBHM/QfE0POXlVLday/B/dmnCO2vBAWCICIwzsBMZhi6dUfGb09D0Z9uSYmX3fNupfq1b0DMyNQ8523BGCgUglRQiCHr3mcA4N26haxDhzF/WWl87kmFuf/AWN5LfiIIgn6ftY9h7te6367PNlLlkocRLC2BGg6DcQ4xKxvZF09C0ew5uv10f/E51b3xKrzffgO5rhZqOAQQwAQB3GaDqW8/ZI47B3mXT9Ol4S8toUTRBIwBJCswD0xtY/Lv+JHMAwfpjx2gSYaiJBeQvYvmU+OGtyE31INJErjFCsXtRua4s9Hn4Sei35fNmkFN778LMdsJJogAA4gIqscDZjSg77LnYD/xpLjtebf9l8pmXgnV7QK3O8Aig0GKArm+DvbRYzBg+arot9vPOZ3kulowgwGkqoCiQA0GQKEQzIOPRrfb58N+wokJ+7Z34TyqfXU1xMws/UUZDkPKycWQFhG0lY89RLWvrIbq84IZDNofY5FZIpCqgkIhqAE/RGcO8mfOQt4U/ckH2iMgBRiyrpj5S3bQ7lvnwL/jR41/WW79PudQfT5Yhh6DgStfi7Zds+pFKr93AcSs7PjtNENVMWDVa1FN2PhhMf08ZxbAuebUbO5rZH6cF09Cr/sfienjzhtvINfHHwIgMIMRTBTBuGbVE1Fk3oKgYBCm/gNQNPeOGK20b9njtH/ZEohZTs2RGg+MgUJBGHv1waA31ydd01tGDycoCsB5fP8T51B9XjjGnq5/Bqlb8zptPfVkqn15FUiWIWZlQ3BkQPV44Bh7WivhqHrheWoq3gBDYRHAOUiNxBCpKgSHAxSWUXHfQl2GK+5bCNXjhpCZpYVZNMcgATAUFML92UZULl0S7UnhTXOh+Hyag01VAcbALVaI2U4Eykqxc+aVqF//VmLPW/OiTuUvOiavUWPxhsggMjCjEQDThEJRNGEFwIxGiNlOUDCI8sULsOfuOzvHC8i06TIPGMgGvbmeOX57GsL1dWCiqD1LwHu7+91i4VTcfw+YJEGw2g7Mj6oCnEMqKETdmtdR99abrfpY8/JKCu2rhGCzAWDgkUjk6NxG580C0elEqKIcu2bNQM3LK1vRKZx1IzP06AU1FNQWtE4fudkC34/bUb1iedKxdl40EYrHDSYI8empKgSbHYWz58QXkPIH76U98+ZC8fsgZmdrEkoE1euFsXcf9Fv6TKuRb1i3FoLNDlWWYySSZBmCzQZ/6Q40fvRBDPPuLzeTb+t/IdgdoHA4hhc1HIbgyEDju+uiv2WdMY7Zho+A4vNqgwZoEyfLEKxWMEnCnjv+jKZPP+5U97RzwkQ2ZH0xG7DiFTgnTQYFAiA5fICHaKdJ29UFAVJuLmpfWoHyBxZ1uqu831+fY7lTroTc0KBNbFs+DgLNwl77xqsUqiwHN5tjd/CIFuEmM+r/+WarR7mXTWGDXv0n6798NbJ+dwEUt1tbG22FNjJvzGQCt9pQvmgB6tetbTVWuVdcqWlsQdDnlwiC1YaalS8k7Vu3W25nUl6+tt7a8MNEEYrbhazzLoS5/wAWM6J7Fs6j6r8/AzErG0wQW6lvUhR0u2NBTIPh6iowSdQPlyACVEKgZEfMo0BpSayJ0OZbJoqQ6+pa/Zx59rmgUChqjrXkEYIAZpBQvnCePt2DgHnAQNbjjgWs95K/ghtNcQe6mXeSZUh5+ah5cTka3nun04Wkxx0LWLe5d0L1eUFyOOEi6ggCpTtiNEorEIEZJIT2VcR9bB4wkPVa/BfWff4iqM0h+/HGKqJRBJsN5W2sjbwpVzJT/4FQ/T79yGZVBTeaENq7B/uffjK5Fpk0GYrbDcZbjFfElBWzneh+6zwGtLnm3ffXx6n2pRWQcvO0hRYZFCYIUNwuZJx+Fhwnj47lkLEkhz4AoKj92Qo8xTN1m4GxDh8BbrXFt6VVFdxkRqiiHBUP3d9lQU4ZY8ay3g8vSRpLRaoKbjZj/7LHu4SPvGlXs96PPAkuSlB8vs4VklTmlgCW5Dibc/EkVnTLbZppo6fpVBXMYIDicuHn225u1WrelddA9Qf0vwVAqgLBbkfty6uTMAwUXj+bGXr00IQ2srYY51A8bjgvuSz6XrQ116aNVPX0UkjOnJgdnYjABBE5l0+N25ihoAiq3i4KaL8LAsyDhsQ8Mh81GMwg6feEc+2wnJfX6mfLwEFMzMrWeI3TLikKuN2OhnfX69PuBNhPGs1yp0yD4nLpL8yIgATKSlD/9r+6RGAzTz+T9X32BRgKi6C4mrRzSScgOmc6c8s4B4VCMPTsmZRW3uSpzD56TGTnjr/QSZYh2O3QDvcH4JxwCbMMPUY7e+oJCRGYJCFcU4WKhx9IOs65U66E6vNoWoQxqKEQDAVFKLrx5mhnoy1VPHy/FnLdlgrnUP1+mI8aDHvkOrctnBdNhOr1HDj0tACTJCiuJliOPiauv8J23HBmG34i5MZGMKlNSiljmk3oakL2+RfFtCtYLPrh4UTgkgHh6v1oeL/zTZuWKPrTn5nodMY9Q7UC43B99GHidw4C1iFD2ZD1xcx6wkjI9XXabWIH0byAnedPYMY+faF4PLFCFzk0UyiInBa7biLkTp6aNHKZCQIUVxNqVr/YWotMvy6uWd0SmhZxoG7Na0l5ybviKmbqNwBqwA8milA9HuRMvqLVOxwAal5ZTf4ft4NbrDELjjEGCgZgO3GkbkM5k37PsidMRHj/vgM7emSA5fp6CBmZ6HHXPbrf939+BZMKCiDX1US44gDjIFlGeF8lMsefi/yrZ8Yx7VI4lKoq/Nu2JX/vIGEZOgxqQN8EIFUFNxgQKCvpcl4GPL+CZV94MeSG+o4TabEIe8xfBGaQoDQ1aT9EBSOEcFUVcqdejcwzx6dkK2eMPY1JBYVQQwksjkgbvm1bW/2UddZ4ZhtxIhSPJ4EWiRy0mxqxZ+G8pBtj3lXXQA1oLgJj7z7In35tK6Y4ANSveV27pdDbjRmHefDQhA31fuARVnTL7VoOdTAI1ecDGEfGqf+H/stXwTJkaMIBHFr8Kcscdw6YIED1+UDBAMSMTBTMvgl9n3i64x5XzhGururw56nC2KuPrrkXhSBAbmrscl4AoM8jT7L862Z1Ci37yJNZ/+dXwnbSKADQ5icUgpSXj+7z70H32+e3a36kgkLt9k9vrIjAuIBwTU3Mo/wZNwCkJjzxkKJpkYb1b8FX8lNCIXFOmMgsw45FuKYGeVddE/NcdG3+nHbNmgFuMsc1V5p3PkNhYaJ2AAAFM2/QvLzff0dqMAD7yJMZPvsaWPpM0m8BoM+jSxmgXf0ySdK87+9/ktK3+mDJTZ9OADeZkOw0yxgDEjnoOhnZZ5/XaaEc1qHDorTcmz8nbrVqv60vbjctLkmJLzUATUPJoZhnjlPGsLIbriH3pk8g2Oy6mzoTBCgeD6qffTopP7mXTYFcV4ucib+PGS/R/eknoFAI3GjUvJsx3BKYKEUcPqnBeuxxBzUxeh73NI4M2E8adVjnJ3/G9XB/vinhO6QoEBwONBZvgGfLt2Qbdrwuz9nnT2DerVsIG4bFPOO+bVsAUUx4biJQfOFJI43DANvxJ7CM08+EnOjmENrVM8kyqp55KinNlhqyJXiosjJyO6EjAFw7LCtud0rMdzZqXllFlU88mpbOXxga3nub9t63sMvmLX/G9eAmk/65GdqNlmi3w73xY7j+s6lDvHC12XGjoyFY5LYiVBnfU9pVqHzyMdr+uzNp9603wdir9yFtO42Oo3rFcvpp0oVUNvMqcKOxy9qxHDWYZZ19XmL/UzMYS0mLxANPqTAZEfzb/tuhBtqLyqVLaOupo6jqb8sQqtgL67Dj4LzgovSZ5AhHzeoVtP3c06nigcUIlJXA0K07ut18W5fOW8977mOCw6Ef5Qvtkkmw2eD5cjMaP3iv3VqEM4MxeZiEyQTPV5vbS7tdaHjvHdp+7hm0/6knoPh9kJxOkKzAMuy4Lm03jYOD55uv6KfJl1D5vQsQrq6G6HSCiGDq1/+QtJ994cVJtQgRgUkiqp5LfqPVFjyaD5HgTpqbTAiUlMD12addYlPuXbSAfr55NsJV+yFlO8EEIRoSbU0LyBGL/c89TWUzpsH/w1YtD0iStOjcYBCWIYn9Zp2F7nPvZFJObuJQJ1WFYLHCt+V71L21pl1rmBt799GPRm0FQs2q5KHE7UXpjGlUs/oFiBmZYEaj5mwj7daMGSQYe/fp9DbTOHjsufsOqnzkATCjEYLFFp23Zpj69jtkvDgnTYZ2lk6sRbjJhOq/p+aTawa3Dh+R3DMZSSBxb/yoQ3acHsquu5rcmzYeiB5ueSMRCV8WnTmd1dwvGwyAeuicjIlQft9Cqn1pFaScXADabVEUBEDgEHPzDxk/hbNuZIZu3aEGA4nD4c1mBEp3oOofz6W8hnn+tKuZYM9InIKJiB1nNKHigcXtYl4P+5Y9Tk0ffQAxJyfW0x3JP2CSBHO//r/6Azo3mxMH8EWiqaOxUIcR9e/8i2pW/gNSXl6M1gA0nxnjghZIegiRc/k0qF5vwnD4ZoT27E6ZLgcA24iRULyJM7ZABG40IlxdhZJplx20Fql9eWX8fGrggEvmf8Q5aSjqnjzCVRQhNzai/p11h3VQqp/7G7jZktD/AOCQO5bzp01npn79oAb0tQjJMsTMLPSYvyjlTZcDQM7lUyOJ+Ilfbg4C837zNUqnX9HhEaj75xsk19drDsq4A0nRogn+kh2/eimxDD1GK0CRVIsIaFj7pv47XQzP999ScNdOMJNJN82g+f+aqF7vIeYOyJ02HarfF1eLNCf9OS+e1C6aHNBinzLHnwO5qSFpog0pMoSMTHi+3IwfLhhP7i83t3sBh/ZVAizJZ5xDDQYRro2N6Py1wX7iSczYs7f2X6T0dr/Ifb77s0/RsGH9Ydk0wvv3aSV/kl3oqArCVfsPDVMtkHPJZcw8ZKgWSd5SSCLJUFJ+AYrmzG2XyR6l0vvBJVqcvt+fNPm/ufBXqHwPdl4/HXsXzaeENYbaQHRkJNVWLKJBgjvLUiX7i0b2+RNSKkzATSaUL74b3q1bDrmQCA4HmMCTm0+MIbCz6/Ne4iF/+rVaXbUWQsy4oCVDXTal3fRaSULPex/STB5ZTkFIFDCTGcxgQO0rq1FyxaXYddMfqG7N6+TfkTgG33rCCM2OTTbQnMP7/bcpduWXjfzp12rZbT4foHddSQRIElS/HztnzeiSIhCJ4Bj1Gybm5CV0C2jX84aYZKdDhazx5zLr8SOgeD2aqcUY1GAAxp69oukY7UErKXCcNIr1+sujIFkGBYPJ85ojxQrEzExAVdBYvAF77roNJVMvxfbxp9FPl06gHZdfQltPG00Vjz0YnUzLoCHMMWYslCb93OnmQgfe775pb59+seh+10Lt8Ksq+huUqoIZjVD9fuyeOwc7/3QDNf67+JAJSvYFF2mea721ESmYESgtge/HHw6LKZg/83pAidQo4xyq14vcqVd1iFbMLGSeMY71WfYsxMwsLWWT86TBYJonnkN0ZGjCEsmc823dAs83XyH7oono1sb26/PYMiY6nVB9vviDHSldGqosR93aN3/1B3UAsI8cxXrcfS9UrxcUDidchEwUwa1WuD4sxs9zZmHbuFNp+3ln0Y6pl1JXXmwUzZ7DLMOOhdzQoHnO44BFKhM2vLMu7vOuRsaYU5lt1ClQfF6ooRBMA49C7uSpHXIXxN2mHCePZkcXb2SZ438H1eOG3NQUSYPkB6rbtQRjWvmeSOlN1e+H4nLBfPRQ9F++Wrd2a++HnwC3WCHXa7nTWnWJA/Q1dW1E7as6ZVw4B0v6J8TfjZn2LNn3KRdjY6xT6DkvuIj1fvRJcJMZcn1d9PZKz6QRMjPBzRYEd5UBioKiOXNhHhBbk7c9PCbzJQx6dS0z9emLcE11ND225brQ/oW1HQ3r1sYnkNK8tWPs4yB/5vXa2cPnQ95VMzpMJ6EN1efhx5nrP5uo7uXV8Hz9BRRXk7awJOnApEWq65EsA7IMZjTCMngIsi+4GDmTfs/wqs4g4UDm4K5b/kjuTZ9AcbsAUTxQw7XZzPr6S1Qtf5byr5rRauJVr0crIRMOxb0uZoIA2e3SLh7aQA34IbtdYKKQoB5uWHPipQAKBTV6kqhLD4oCnsI/6cw8YxwDgN133UauD9+H4nZpFUok6UBtW1nWzgKqAjEnDwWTr0DR7JsY3j4hAY+hxDw2o7mkawIMfmsD23vvQmrcsB5KUyPABW1dRPhjkohQRTl233Ub9Vr0QOt58/mguN0g0mmHc6geL1Rfx6+K7SeMZGV/mEGhvXsPKho85Q/9pSXk3vQJvN99jcDPP0NpbIAaDIGJAgSbHYaibrAMHQb76FNgH9n+lEzvti3U9EExvN99g1BlBVSPO1LW0gRus8F67PHotfjBVnT3LV1Ccl0doFPVkXEOxe+HdegwTVhboO6tNeT5cjMEi47TizFA1gqRFc35c9L+NBZvoKaPPoRgterTi+T3d5t7Z8rj49vxEzW99w48X32BUMVezaHLGASHA8befWEfdQrypl6dEj3XfzZRw7q39HlsBhF6zFuYMo9Vz/2NPF9/geCe3Vplf1nWavk6MmDs0RP9nnq+Fa2q5c9S8OddYEYTQPHGioOCQRh79YpfzSZFuDd/TuG6WmSf0/Hc/P8HIGDRQyirz1UAAAAASUVORK5CYII=" alt="Cantrav">
    <div class="sep"></div>
    <span>Financial Dashboard</span>
  </div>
  <div class="hdr-right">
    <select id="snap-select" style="display:none" onchange="switchSnapshot(this.value)"></select>
    
    <input type="file" id="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
  </div>
</div>

<div class="tabs" id="tab-bar">
  <button class="tab-btn active" onclick="switchTab(0)">Summary</button>
  <button class="tab-btn" onclick="switchTab(1)">Sales Pacing</button>
  <button class="tab-btn" onclick="switchTab(2)">Year over Year</button>
  <button class="tab-btn" onclick="switchTab(3)">Month over Month</button>
  <button class="tab-btn" onclick="switchTab(4)">Sales Rep</button>
  <button class="tab-btn" onclick="switchTab(5)">Destinations</button>
  <button class="tab-btn" onclick="switchTab(6)" id="upload-tab-btn" style="margin-left:auto;color:var(--red)">&#9881; Data Source</button>
</div>

<div class="content">
  <div id="error-msg" class="note" style="display:none"></div>
  
  <div id="dashboard">
    <div class="filters">
      <label>Filters:</label>
      <select id="f-year" onchange="applyFilters()"><option value="all">All Years</option></select>
      <select id="f-rep" onchange="applyFilters()"><option value="all">All Sales Reps</option></select>
      <select id="f-dest" onchange="applyFilters()"><option value="all">All Destinations</option></select>
      <button class="clear-btn" id="clear-btn" style="display:none" onclick="clearFilters()">Clear</button>
    </div>

    <div id="tab-0" class="tab-content active"></div>
    <div id="tab-1" class="tab-content"></div>
    <div id="tab-2" class="tab-content"></div>
    <div id="tab-3" class="tab-content"></div>
    <div id="tab-4" class="tab-content"></div>
    <div id="tab-5" class="tab-content"></div>
    <div id="tab-6" class="tab-content">
      <div class="card" style="max-width:700px;margin:20px auto">
        <h3>Google Sheets Data Source</h3>
        <p style="font-size:13px;color:var(--gray);margin-bottom:16px">Connect your dashboard to a published Google Sheet. Data will auto-load every time the dashboard is opened.</p>
        
        <div style="margin-bottom:16px">
          <label style="font-size:12px;font-weight:600;color:var(--navy);display:block;margin-bottom:4px">Published Google Sheet URL</label>
          <div style="display:flex;gap:8px">
            <input type="text" id="gs-url" placeholder="https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv" style="flex:1;padding:10px 12px;border:1px solid #ccc;border-radius:6px;font-size:13px">
            <button class="btn" onclick="saveAndLoadGS()" style="white-space:nowrap">Connect & Load</button>
          </div>
        </div>

        <div id="gs-status" style="display:none;padding:12px;border-radius:8px;font-size:12px;margin-bottom:16px"></div>
        
        <div style="background:#f9fafb;border-radius:8px;padding:16px;font-size:12px;color:var(--navy)">
          <strong>How to set up:</strong>
          <ol style="margin:8px 0 0 16px;line-height:2">
            <li>Open your Google Sheet with Viper data</li>
            <li>Go to <strong>File → Share → Publish to web</strong></li>
            <li>Select the correct sheet tab</li>
            <li>Choose <strong>Comma-separated values (.csv)</strong> as the format</li>
            <li>Click <strong>Publish</strong> and copy the URL</li>
            <li>Paste the URL above and click <strong>Connect & Load</strong></li>
          </ol>
          <p style="margin-top:12px;color:var(--gray)">The URL is saved in your browser. Next time you open the dashboard, data loads automatically.</p>
        </div>
      </div>

      <div class="card" style="max-width:700px;margin:20px auto">
        <h3>Annual Revenue Targets</h3>
        <p style="font-size:12px;color:var(--gray);margin-bottom:12px">Revenue targets per year. Best practice: add a "Targets" tab to your Google Sheet with columns <strong>Year</strong> and <strong>Target</strong> so all viewers see the same targets. You can also override locally below.</p>
        <div id="target-editor" style="display:flex;flex-direction:column;gap:8px"></div>
        <button class="btn" onclick="addTargetYear()" style="margin-top:10px;padding:6px 14px;font-size:11px">+ Add Year</button>
      </div>

      <div class="card" style="max-width:700px;margin:20px auto">
        <h3>Manual Upload (Backup)</h3>
        <p style="font-size:12px;color:var(--gray);margin-bottom:12px">You can also upload an Excel or CSV file directly.</p>
        <div class="upload-zone" style="padding:30px" onclick="document.getElementById('file-input').click()"
             ondragover="event.preventDefault();this.classList.add('dragover')"
             o<script>
const DEFAULT_TARGET=30000000, CONV=0.4;
const MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const MONTH_FULL=["January","February","March","April","May","June","July","August","September","October","November","December"];
let allData=[], filteredData=[], snapshots=[], activeSnapId=null, currentTab=0, charts={};

// === TARGET MANAGEMENT ===
// Targets loaded from Google Sheets "Targets" tab, with localStorage as fallback/override
let gsTargets={};

function getTargets(){
  // Merge: Google Sheet targets as base, localStorage overrides on top
  const merged={...gsTargets};
  try{const s=localStorage.getItem("cantrav_targets");if(s){const local=JSON.parse(s);Object.assign(merged,local);}}catch(e){}
  return merged;
}
function saveTargets(t){try{localStorage.setItem("cantrav_targets",JSON.stringify(t));}catch(e){}}
function getTarget(yr){const t=getTargets();return t[yr]||DEFAULT_TARGET;}
function setTarget(yr,val){
  // Save to localStorage (overrides Google Sheet value for this browser)
  let local={};
  try{const s=localStorage.getItem("cantrav_targets");if(s)local=JSON.parse(s);}catch(e){}
  local[yr]=val;
  saveTargets(local);
  renderAllTabs();
}
function renderTargetEditor(){
  const el=document.getElementById("target-editor");if(!el)return;
  const yrs=[...new Set(allData.map(d=>d.yr).filter(Boolean))].sort();
  const targets=getTargets();
  Object.keys(targets).forEach(y=>{if(!yrs.includes(parseInt(y)))yrs.push(parseInt(y));});
  yrs.sort();
  if(!yrs.length)yrs.push(new Date().getFullYear());
  
  let info='';
  if(Object.keys(gsTargets).length>0){
    info='<div style="background:#e8f5e9;padding:10px 14px;border-radius:6px;font-size:11px;color:#2e7d32;margin-bottom:12px">Targets loaded from Google Sheets. Local edits below override for this browser only. To change for everyone, update the Targets tab in Google Sheets.</div>';
  } else {
    info='<div style="background:#fff3cd;padding:10px 14px;border-radius:6px;font-size:11px;color:#856404;margin-bottom:12px">To share targets with all viewers, add a &quot;Targets&quot; tab to your Google Sheet with columns: <strong>Year</strong> and <strong>Target</strong>. Local edits below are saved only in this browser.</div>';
  }
  
  el.innerHTML=info+yrs.map(y=>{
    const val=targets[y]||DEFAULT_TARGET;
    const fromGS=gsTargets[y]!==undefined;
    return '<div style="display:flex;align-items:center;gap:8px"><label style="font-size:12px;font-weight:600;color:var(--navy);min-width:50px">'+y+'</label><span style="font-size:13px;color:var(--gray)">$</span><input type="number" value="'+val+'" onchange="setTarget('+y+',parseInt(this.value))" style="padding:6px 10px;border:1px solid #ccc;border-radius:4px;font-size:13px;width:160px"><span style="font-size:11px;color:var(--gray)">'+fmt(val)+(fromGS?" (from Google Sheet)":"")+'</span></div>';
  }).join("");
}
function addTargetYear(){
  const t=getTargets();
  const yrs=Object.keys(t).map(Number);
  const next=yrs.length?Math.max(...yrs)+1:new Date().getFullYear();
  let local={};
  try{const s=localStorage.getItem("cantrav_targets");if(s)local=JSON.parse(s);}catch(e){}
  local[next]=DEFAULT_TARGET;saveTargets(local);renderTargetEditor();
}

// Load targets from a second Google Sheet tab
function loadTargetsFromGS(baseUrl){
  // The targets tab URL: replace gid or add gid for second sheet
  // Published CSV for a specific sheet tab uses &gid=XXXX
  // Try fetching with sheet name "Targets"
  let tUrl=baseUrl;
  // If URL has gid= parameter, replace it; otherwise we need the Targets tab
  // Easiest: publish each tab separately and provide both URLs
  // OR: use a convention - targets sheet published as a second URL
  // For simplicity: try to fetch from same spreadsheet but with &sheet=Targets
  if(tUrl.includes("/pub?")){
    tUrl=tUrl.replace(/&gid=\d+/,"").replace("pub?","pub?sheet=Targets&");
  } else if(tUrl.includes("/pub")){
    tUrl=tUrl+"?sheet=Targets&output=csv";
  }
  
  fetch(tUrl)
    .then(r=>{if(!r.ok)throw new Error("No Targets tab");return r.text();})
    .then(text=>{
      const res=Papa.parse(text,{header:true,skipEmptyLines:true,dynamicTyping:true});
      res.data.forEach(row=>{
        const yr=parseInt(row["Year"]||row["year"]);
        const tgt=parseFloat(row["Target"]||row["target"]||row["Revenue Target"]);
        if(yr&&!isNaN(tgt)&&tgt>0){gsTargets[yr]=tgt;}
      });
      if(Object.keys(gsTargets).length>0){
        console.log("Loaded targets from Google Sheets:",gsTargets);
        renderTargetEditor();
        renderAllTabs();
      }
    })
    .catch(()=>{console.log("No Targets tab found in Google Sheet - using defaults/local");});
}

function classify(s){if(["Final Invoice","Post Mortem"].includes(s))return"realized";if(s==="Sold")return"confirmed";if(s==="Prelim")return"preliminary";return"other";}
function fmt(v){if(!v||isNaN(v))return"$0";return Math.abs(v)>=1e6?"$"+(v/1e6).toFixed(1)+"M":Math.abs(v)>=1e3?"$"+(v/1e3).toFixed(0)+"K":"$"+v.toFixed(0);}
function fmtF(v){return(!v||isNaN(v))?"$0":"$"+Math.round(v).toLocaleString("en-US");}
function badge(st,sc){const cls="badge badge-"+sc;return'<span class="'+cls+'">'+st+"</span>";}

function parseRow(r){
  const fv=parseFloat(r["Final Value ($)"]||r["Final Value"]||"");
  const ev=parseFloat(r["Estimated Value ($)"]||r["Estimated Value"]||"")||0;
  const rv=(!isNaN(fv)&&fv>0)?fv:ev;
  let sd=null;
  if(r["Start Date"]){
    const raw=r["Start Date"];
    if(typeof raw==="number"){sd=new Date((raw-25569)*86400000);}
    else{sd=new Date(raw);}
    if(isNaN(sd.getTime()))sd=null;
  }
  const yr=r["Year"]?parseInt(r["Year"]):(sd?sd.getFullYear():null);
  const mc=r["Main Contact"];
  const gsMin=parseInt(r["Group Size Min"])||0;
  const gsMax=parseInt(r["Group Size Max"])||0;
  const gs=gsMax>gsMin?gsMin+"-"+gsMax:(gsMin>0?gsMin+"":"\u2014");
  const gsNum=gsMax>0?gsMax:(gsMin>0?gsMin:0);
  return{pid:r["Program Id"]||"",pn:r["Program Name"]||"",cn:r["Company Name"]||"",st:r["Status"]||"",sc:classify(r["Status"]||""),sd,yr,mo:sd?sd.getMonth()+1:null,ev:rv,estVal:ev,finVal:(!isNaN(fv))?fv:0,mc:(mc&&mc!=="NaN"&&mc!=="nan"&&mc!=="")?mc:"Unassigned",dest:r["Destinations"]||"Unknown",gs,gsNum,link:r["Link"]||""};
}

function handleDrop(e){e.preventDefault();e.currentTarget.classList.remove("dragover");if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0]);}
function handleFileSelect(e){if(e.target.files[0])processFile(e.target.files[0]);e.target.value="";}

function processFile(file){
  document.getElementById("error-msg").style.display="none";
  if(file.name.match(/\.csv$/i)){
    const reader=new FileReader();
    reader.onload=function(e){
      const res=Papa.parse(e.target.result,{header:true,skipEmptyLines:true,dynamicTyping:true});
      const parsed=res.data.map(parseRow).filter(d=>d.pn||d.ev);
      if(!parsed.length){showError("No valid data found. Check column headers.");return;}
      loadData(parsed,file.name);
    };
    reader.readAsText(file);
  } else if(file.name.match(/\.xlsx?$/i)){
    const reader=new FileReader();
    reader.onload=function(e){
      try{
        const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(ws,{defval:""});
        const parsed=json.map(parseRow).filter(d=>d.pn||d.ev);
        if(!parsed.length){showError("No valid data found. Check column headers match Viper export.");return;}
        loadData(parsed,file.name);
      }catch(err){showError("Error reading Excel file: "+err.message);}
    };
    reader.readAsArrayBuffer(file);
  } else {
    showError("Unsupported file type. Please upload a .xlsx or .csv file.");
  }
}

function showError(msg){const el=document.getElementById("error-msg");el.innerHTML="<strong>Note:</strong> "+msg;el.style.display="block";}

function loadData(parsed,filename){
  const snap={id:Date.now(),label:filename.replace(/\.[^.]+$/,""),ts:new Date().toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}),data:parsed,n:parsed.length};
  snapshots.unshift(snap);
  activeSnapId=snap.id;
  allData=parsed;
  switchTab(0);
  populateFilters();
  applyFilters();
  updateSnapUI();
  renderTargetEditor();
}

function switchSnapshot(id){
  id=parseInt(id);
  const s=snapshots.find(x=>x.id===id);
  if(s){activeSnapId=id;allData=s.data;populateFilters();applyFilters();updateSnapUI();}
}
function deleteSnapshot(id){
  snapshots=snapshots.filter(x=>x.id!==id);
  if(activeSnapId===id){
    if(snapshots.length){activeSnapId=snapshots[0].id;allData=snapshots[0].data;populateFilters();applyFilters();}
    else{allData=[];renderAllTabs();}
  }
  updateSnapUI();
}

function updateSnapUI(){
  const sel=document.getElementById("snap-select");
  if(snapshots.length>0){
    sel.style.display="inline";
    sel.innerHTML=snapshots.map(s=>'<option value="'+s.id+'" '+(s.id===activeSnapId?"selected":"")+'>'+s.label+" \u2014 "+s.ts+"</option>").join("");
  }else sel.style.display="none";
  const hist=document.getElementById("snap-history");
  if(snapshots.length>1){
    hist.style.display="block";
    document.getElementById("snap-list").innerHTML=snapshots.map(s=>
      '<div class="snap-item '+(s.id===activeSnapId?"active":"")+'"><div class="snap-info">'
      +(s.id===activeSnapId?'<span class="snap-dot"></span>':"")
      +'<span class="snap-label">'+s.label+'</span><span class="snap-meta">'+s.ts+" \u00b7 "+s.n+' records</span></div>'
      +'<div class="snap-actions">'
      +(s.id!==activeSnapId?'<button class="snap-load" onclick="switchSnapshot('+s.id+')">Load</button>':"")
      +'<button class="snap-del" onclick="deleteSnapshot('+s.id+')">Delete</button></div></div>'
    ).join("");
  }else hist.style.display="none";
}

function populateFilters(){
  const yrs=[...new Set(allData.map(d=>d.yr).filter(Boolean))].sort();
  const rps=[...new Set(allData.map(d=>d.mc).filter(v=>v&&v!=="Unassigned"))].sort();
  const dst=[...new Set(allData.flatMap(d=>d.dest.split(",").map(s=>s.trim())).filter(Boolean))].sort();
  document.getElementById("f-year").innerHTML='<option value="all">All Years</option>'+yrs.map(y=>'<option value="'+y+'">'+y+"</option>").join("");
  document.getElementById("f-rep").innerHTML='<option value="all">All Sales Reps</option>'+rps.map(r=>'<option value="'+r+'">'+r+"</option>").join("");
  document.getElementById("f-dest").innerHTML='<option value="all">All Destinations</option>'+dst.map(d=>'<option value="'+d+'">'+d+"</option>").join("");
}

function clearFilters(){document.getElementById("f-year").value="all";document.getElementById("f-rep").value="all";document.getElementById("f-dest").value="all";applyFilters();}

function applyFilters(){
  const fy=document.getElementById("f-year").value;
  const fr=document.getElementById("f-rep").value;
  const fd=document.getElementById("f-dest").value;
  filteredData=allData.filter(d=>{
    if(fy!=="all"&&d.yr!==parseInt(fy))return false;
    if(fr!=="all"&&d.mc!==fr)return false;
    if(fd!=="all"&&!d.dest.includes(fd))return false;
    return true;
  });
  document.getElementById("clear-btn").style.display=(fy!=="all"||fr!=="all"||fd!=="all")?"inline":"none";
  renderAllTabs();
}

function switchTab(idx){
  currentTab=idx;
  document.querySelectorAll(".tab-btn").forEach((b,i)=>b.classList.toggle("active",i===idx));
  document.querySelectorAll(".tab-content").forEach((c,i)=>c.classList.toggle("active",i===idx));
  if(idx===6)renderTargetEditor();
}

function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}

function kpiHTML(l,v,s,c){
  return'<div class="kpi" style="border-left-color:'+(c||"var(--navy)")+'"><div class="kpi-label">'+l+'</div><div class="kpi-value" style="color:'+(c||"var(--navy)")+'">'+v+'</div>'+(s?'<div class="kpi-sub">'+s+'</div>':"")+'</div>';
}

function tableHTML(headers,rows){
  return'<div style="overflow-x:auto"><table><thead><tr>'+headers.map(h=>"<th>"+h+"</th>").join("")+'</tr></thead><tbody>'+rows.join("")+'</tbody></table></div>';
}

function filterTable(){
  const sf=document.getElementById("tf-status")?document.getElementById("tf-status").value:"all";
  const rf=document.getElementById("tf-rep")?document.getElementById("tf-rep").value:"all";
  const sq=document.getElementById("tf-search")?document.getElementById("tf-search").value.toLowerCase():"";
  const d=window._tableData||[];
  const fd=d.filter(x=>{
    if(sf!=="all"&&x.sc!==sf)return false;
    if(rf!=="all"&&x.mc!==rf)return false;
    if(sq&&!x.pn.toLowerCase().includes(sq)&&!x.cn.toLowerCase().includes(sq))return false;
    return true;
  });
  const rows=fd.map(x=>{
    const pnLink=x.link?'<a href="'+x.link+'" target="_blank" title="Open in Viper: '+x.link+'" style="color:var(--navy);text-decoration:none;border-bottom:1px dashed var(--gray)">'+x.pid+" \u2014 "+x.pn+'</a>':'<span>'+x.pid+" \u2014 "+x.pn+'</span>';
    return"<tr><td style='font-weight:600'>"+pnLink+"</td><td>"+x.cn+"</td><td>"+badge(x.st,x.sc)+"</td><td>"+x.mc+"</td><td>"+x.dest+"</td><td style='font-weight:600'>"+fmtF(x.ev)+"</td><td>"+x.gs+"</td><td>"+(x.sd?x.sd.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"\u2014")+"</td></tr>";
  });
  const el=document.getElementById("programs-table");
  if(el)el.innerHTML=tableHTML(["Program","Company","Status","Sales Rep","Destination","Value","Group Size","Start"],rows);
}

// Helper: build monthly status breakdown table like the screenshot
function statusBreakdownTable(data,yr){
  const cats=["confirmed","realized","preliminary","confirmed_sold"];
  // For the table: Confirmed (sc=confirmed), Final Invoice (st=Final Invoice), Prelim, Sold
  const statuses=[
    {key:"confirmed",label:"Confirmed",filter:x=>x.sc==="confirmed"},
    {key:"finvoice",label:"Final Invoice",filter:x=>x.st==="Final Invoice"},
    {key:"prelim",label:"Prelim",filter:x=>x.sc==="preliminary"},
    {key:"sold",label:"Sold",filter:x=>x.st==="Sold"||x.sc==="confirmed"}
  ];
  // Actually match the screenshot: Confirmed, Final Invoice, Prelim, Sold
  const sts=[
    {label:"Confirmed",filter:x=>x.st==="Sold"},
    {label:"Final Invoice",filter:x=>x.st==="Final Invoice"},
    {label:"Prelim",filter:x=>x.sc==="preliminary"},
    {label:"Post Mortem",filter:x=>x.st==="Post Mortem"}
  ];
  let h="<tr><th></th>";
  sts.forEach(s=>{h+="<th colspan='2' style='text-align:center;border-bottom:2px solid var(--amb);background:#fffde7'>"+s.label+"</th>";});
  h+="<th colspan='2' style='text-align:center;border-bottom:2px solid var(--navy);background:#e3f2fd'>Total</th></tr>";
  h+="<tr><th></th>";
  sts.forEach(()=>{h+="<th>Revenue</th><th>Prog#</th>";});
  h+="<th>Revenue</th><th>Prog#</th></tr>";

  let rows="";let totals={};
  sts.forEach(s=>{totals[s.label]={rev:0,n:0};});
  totals.total={rev:0,n:0};

  MONTHS.forEach((mn,mi)=>{
    const m=mi+1;
    const md=data.filter(x=>x.mo===m&&(!yr||x.yr===yr));
    let row="<tr><td style='font-weight:600'>"+mn+"</td>";
    let mTotRev=0,mTotN=0;
    sts.forEach(s=>{
      const sd=md.filter(s.filter);
      const rev=sd.reduce((a,x)=>a+x.ev,0);
      const n=sd.length;
      row+="<td>"+((rev>0)?fmtF(rev):"")+"</td><td style='text-align:center'>"+((n>0)?n:"")+"</td>";
      totals[s.label].rev+=rev;totals[s.label].n+=n;
      mTotRev+=rev;mTotN+=n;
    });
    totals.total.rev+=mTotRev;totals.total.n+=mTotN;
    row+="<td style='font-weight:700'>"+((mTotRev>0)?fmtF(mTotRev):"")+"</td><td style='text-align:center;font-weight:700'>"+((mTotN>0)?mTotN:"")+"</td></tr>";
    rows+=row;
  });

  // Grand total row
  let gt="<tr style='background:#fffde7;font-weight:700'><td>Grand Total</td>";
  sts.forEach(s=>{gt+="<td>"+fmtF(totals[s.label].rev)+"</td><td style='text-align:center'>"+totals[s.label].n+"</td>";});
  gt+="<td>"+fmtF(totals.total.rev)+"</td><td style='text-align:center'>"+totals.total.n+"</td></tr>";
  rows+=gt;

  return'<div style="overflow-x:auto"><table><thead>'+h+'</thead><tbody>'+rows+'</tbody></table></div>';
}

function renderAllTabs(){
  const d=filteredData;
  if(!d.length&&!allData.length){
    document.getElementById("tab-0").innerHTML='<div style="text-align:center;padding:60px 20px"><div style="font-size:40px;margin-bottom:12px;opacity:.4">\ud83d\udcca</div><h2 style="font-family:Georgia,serif;color:var(--navy);font-size:20px;margin-bottom:8px">No Data Loaded</h2><p style="color:var(--gray);font-size:13px;margin-bottom:16px">Connect your Google Sheet or upload a file to populate the dashboard.</p><button class="btn" style="padding:10px 24px;font-size:13px" onclick="switchTab(6)">Connect Data Source</button></div>';
    for(let i=1;i<=5;i++)document.getElementById("tab-"+i).innerHTML='<div style="text-align:center;padding:40px;color:var(--gray)">Upload data to view this tab.</div>';
    return;
  }
  if(!d.length){
    document.getElementById("tab-0").innerHTML='<div style="text-align:center;padding:40px;color:var(--gray)">No programs match the current filters.</div>';
    return;
  }

  // Determine active year for target
  const activeYr=parseInt(document.getElementById("f-year").value)||null;
  const targetYr=activeYr||new Date().getFullYear();
  const TARGET=getTarget(targetYr);

  const re=d.filter(x=>x.sc==="realized"),co=d.filter(x=>x.sc==="confirmed"),pr=d.filter(x=>x.sc==="preliminary");
  const rR=re.reduce((a,x)=>a+x.ev,0),cR=co.reduce((a,x)=>a+x.ev,0),pR=pr.reduce((a,x)=>a+x.ev,0),wP=pR*CONV;
  const proj=rR+cR+wP,gap=Math.max(0,TARGET-proj),pct=(proj/TARGET)*100;
  const ob=rR+cR;

  // === TAB 0: SUMMARY ===
  const allGS=d.filter(x=>x.gsNum>0);
  const avgGS=allGS.length?Math.round(allGS.reduce((a,x)=>a+x.gsNum,0)/allGS.length):0;
  let t0='<div class="kpi-row">'+kpiHTML("Total Projected",fmt(proj),pct.toFixed(1)+"% of "+fmt(TARGET)+" target","#000")+kpiHTML("Realized",fmt(rR),re.length+" programs","var(--grn)")+kpiHTML("Confirmed (Sold)",fmt(cR),co.length+" programs","var(--amb)")+kpiHTML("Gap to Target",fmt(gap),gap>0?"Sales needed":"Target met!",gap>0?"var(--red)":"var(--grn)")+kpiHTML("Programs",d.length+"","Total in view","var(--navy)")+kpiHTML("Avg Group Size",avgGS>0?avgGS.toLocaleString():"\u2014",allGS.length+" with data","var(--navy)")+'</div>';
  t0+='<div class="chart-row"><div class="card wide"><h3>Monthly Revenue Breakdown</h3><canvas id="c-summary-bar"></canvas></div><div class="card narrow"><h3>Revenue by Status</h3><canvas id="c-summary-pie"></canvas></div></div>';
  t0+='<div class="card"><h3>Progress to '+fmt(TARGET)+' Target'+(activeYr?' ('+activeYr+')':'')+'</h3><div class="progress"><div class="progress-seg" style="left:0;width:'+Math.min(rR/TARGET*100,100)+'%;background:var(--grn)"></div><div class="progress-seg" style="left:'+(rR/TARGET*100)+'%;width:'+Math.min(cR/TARGET*100,100-rR/TARGET*100)+'%;background:var(--amb)"></div><div class="progress-seg" style="left:'+((rR+cR)/TARGET*100)+'%;width:'+Math.min(wP/TARGET*100,100-(rR+cR)/TARGET*100)+'%;background:var(--red);opacity:.5"></div><div class="progress-label">'+pct.toFixed(1)+'%</div></div><div class="legend-row"><span><span class="legend-dot" style="background:var(--grn)"></span>Realized: '+fmtF(rR)+'</span><span><span class="legend-dot" style="background:var(--amb)"></span>Confirmed: '+fmtF(cR)+'</span><span><span class="legend-dot" style="background:var(--red);opacity:.5"></span>Prelim (40%): '+fmtF(wP)+'</span></div></div>';
  t0+='<div class="card"><h3>All Programs</h3><div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"><select id="tf-status" onchange="filterTable()" style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:11px"><option value="all">All Statuses</option><option value="realized">Realized</option><option value="confirmed">Confirmed</option><option value="preliminary">Preliminary</option></select><select id="tf-rep" onchange="filterTable()" style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:11px"><option value="all">All Reps</option></select><input id="tf-search" oninput="filterTable()" placeholder="Search programs..." style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:11px;min-width:180px"></div><div id="programs-table"></div></div>';
  document.getElementById("tab-0").innerHTML=t0;
  const tReps=[...new Set(d.map(x=>x.mc).filter(v=>v&&v!=="Unassigned"))].sort();
  document.getElementById("tf-rep").innerHTML='<option value="all">All Reps</option>'+tReps.map(r=>'<option value="'+r+'">'+r+'</option>').join("");
  window._tableData=d;
  filterTable();

  const mData=MONTHS.map((_,i)=>{const m=i+1;return{r:d.filter(x=>x.mo===m&&x.sc==="realized").reduce((a,x)=>a+x.ev,0),c:d.filter(x=>x.mo===m&&x.sc==="confirmed").reduce((a,x)=>a+x.ev,0),p:d.filter(x=>x.mo===m&&x.sc==="preliminary").reduce((a,x)=>a+x.ev*CONV,0)};}); 
  destroyChart("c-summary-bar");
  charts["c-summary-bar"]=new Chart(document.getElementById("c-summary-bar"),{type:"bar",data:{labels:MONTHS,datasets:[{label:"Realized",data:mData.map(m=>m.r),backgroundColor:"#2E8B57"},{label:"Confirmed",data:mData.map(m=>m.c),backgroundColor:"#E8A317"},{label:"Prelim (40%)",data:mData.map(m=>m.p),backgroundColor:"rgba(210,57,49,0.5)"}]},options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true,ticks:{callback:v=>fmt(v)}}},plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+": "+fmtF(ctx.parsed.y)}}}}});
  const pieVals=[rR,cR,wP].filter(v=>v>0);const pieLabels=["Realized","Confirmed","Prelim (40%)"].filter((_,i)=>[rR,cR,wP][i]>0);const pieCols=["#2E8B57","#E8A317","rgba(210,57,49,0.7)"].filter((_,i)=>[rR,cR,wP][i]>0);
  destroyChart("c-summary-pie");
  charts["c-summary-pie"]=new Chart(document.getElementById("c-summary-pie"),{type:"doughnut",data:{labels:pieLabels,datasets:[{data:pieVals,backgroundColor:pieCols}]},options:{responsive:true,plugins:{tooltip:{callbacks:{label:ctx=>ctx.label+": "+fmtF(ctx.parsed)}}}}});

  // === TAB 1: PACING ===
  const now=new Date(),q3=new Date(targetYr,8,30),ys=new Date(targetYr,0,1);
  const de=Math.floor((now-ys)/864e5),dq=Math.max(0,Math.floor((q3-now)/864e5)),tq=Math.floor((q3-ys)/864e5);
  const tp=Math.max(0,Math.min(100,(de/tq*100))).toFixed(1),rp=(proj/TARGET*100).toFixed(1);
  let t1='<div class="kpi-row">'+kpiHTML("On the Books",fmt(ob),(re.length+co.length)+" programs","var(--navy)")+kpiHTML("Pipeline (Raw)",fmt(pR),pr.length+" programs","var(--gray)")+kpiHTML("Pipeline (40%)",fmt(wP),"Weighted","var(--amb)")+kpiHTML("Projected",fmt(proj),rp+"% of target",proj>=TARGET?"var(--grn)":"var(--navy)")+'</div>';
  t1+='<div class="gap-box '+(gap>0?"red":"green")+'"><div><h3 class="gap-title" style="color:'+(gap>0?"var(--red)":"var(--grn)")+'">'+(gap>0?"Revenue Gap to Close":"Target Achieved!")+'</h3><p style="font-size:12px;color:var(--navy);margin-top:4px">'+(gap>0?dq+" days to Q3 end (Sept 30)":"Projected meets target")+'</p></div><div style="text-align:right"><div class="gap-amount" style="color:'+(gap>0?"var(--red)":"var(--grn)")+'">'+fmt(gap)+'</div>'+(gap>0?'<div style="font-size:11px;color:var(--gray)">~'+fmt(gap/Math.max(dq/30,1))+'/mo needed</div>':"")+'</div></div>';
  t1+='<div class="card"><h3>Pacing: Time vs Revenue</h3><div style="display:flex;gap:16px;margin-bottom:14px;flex-wrap:wrap"><div style="flex:1"><div style="font-size:10px;color:var(--gray);margin-bottom:2px">Time Elapsed to Q3</div><div class="progress" style="height:20px"><div class="progress-seg" style="left:0;width:'+tp+'%;background:var(--navy)"></div><div class="progress-label">'+tp+'%</div></div></div><div style="flex:1"><div style="font-size:10px;color:var(--gray);margin-bottom:2px">Revenue Progress</div><div class="progress" style="height:20px"><div class="progress-seg" style="left:0;width:'+Math.min(rp,100)+'%;background:'+(parseFloat(rp)>=parseFloat(tp)?"var(--grn)":"var(--red)")+'"></div><div class="progress-label">'+rp+'%</div></div></div></div><canvas id="c-pacing"></canvas></div>';
  const pRows=[...d].sort((a,b)=>b.ev-a.ev).map(x=>{
    const pnLink=x.link?'<a href="'+x.link+'" target="_blank" title="Open in Viper" style="color:var(--navy);text-decoration:none;border-bottom:1px dashed var(--gray)">'+x.pid+" \u2014 "+x.pn+'</a>':x.pid+" \u2014 "+x.pn;
    return"<tr><td style='font-weight:600'>"+pnLink+"</td><td>"+x.cn+"</td><td>"+badge(x.st,x.sc)+"</td><td>"+fmtF(x.ev)+"</td><td style='font-weight:600'>"+fmtF(x.sc==="preliminary"?x.ev*CONV:x.ev)+"</td><td>"+(x.sd?x.sd.toLocaleDateString("en-US",{month:"short",day:"numeric"}):"\u2014")+"</td><td>"+x.mc+"</td></tr>";
  });
  t1+='<div class="card"><h3>Pipeline Detail</h3>'+tableHTML(["Program","Company","Status","Value","Weighted","Start","Rep"],pRows)+'</div>';
  document.getElementById("tab-1").innerHTML=t1;
  let cumT=0,cumOB=0;const mt2=TARGET/12;const pcData=MONTHS.map((_,i)=>{const m=i+1;cumT+=mt2;cumOB+=d.filter(x=>x.mo===m&&(x.sc==="realized"||x.sc==="confirmed")).reduce((a,x)=>a+x.ev,0);return{t:Math.round(cumT),ob:Math.round(cumOB)};}); 
  destroyChart("c-pacing");
  charts["c-pacing"]=new Chart(document.getElementById("c-pacing"),{type:"line",data:{labels:MONTHS,datasets:[{label:"Target",data:pcData.map(x=>x.t),borderColor:"#D23931",borderDash:[8,4],fill:false,tension:.3},{label:"On Books",data:pcData.map(x=>x.ob),borderColor:"#0A2636",backgroundColor:"rgba(10,38,54,.15)",fill:true,tension:.3}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>fmt(v)}}},plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+": "+fmtF(ctx.parsed.y)}}}}});

  // === TAB 2: YEAR OVER YEAR ===
  const yrs=[...new Set(allData.map(x=>x.yr).filter(Boolean))].sort();
  const yc=["#0A2636","#D23931","#E8A317","#2E8B57","#A2A2A2"];
  // Year comparison selectors
  let t2='<div class="card" style="margin-bottom:18px"><div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><span style="font-size:12px;font-weight:600;color:var(--navy)">Compare:</span><select id="yoy-y1" onchange="renderYoYComparison()" style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:12px">';
  yrs.forEach((y,i)=>{t2+='<option value="'+y+'"'+(i===yrs.length-2?' selected':'')+'>'+y+'</option>';});
  t2+='</select><span style="font-size:12px;color:var(--gray)">vs</span><select id="yoy-y2" onchange="renderYoYComparison()" style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:12px">';
  yrs.forEach((y,i)=>{t2+='<option value="'+y+'"'+(i===yrs.length-1?' selected':'')+'>'+y+'</option>';});
  t2+='</select></div></div>';
  t2+='<div id="yoy-kpis"></div><div id="yoy-chart" class="card"><h3>Monthly Comparison</h3><canvas id="c-yoy-compare"></canvas></div>';
  t2+='<div id="yoy-table" class="card"></div>';
  t2+='<div class="card"><h3>All Years Overview</h3><canvas id="c-yoy-bar"></canvas></div>';
  document.getElementById("tab-2").innerHTML=t2;

  // Render YoY comparison
  window._allDataForYoY=allData;
  renderYoYComparison();

  const yd=yrs.map(y=>{const r=allData.filter(x=>x.yr===y);return{y,rev:r.reduce((a,x)=>a+x.ev,0),n:r.length};});
  destroyChart("c-yoy-bar");
  charts["c-yoy-bar"]=new Chart(document.getElementById("c-yoy-bar"),{type:"bar",data:{labels:yd.map(y=>y.y+""),datasets:[{label:"Revenue",data:yd.map(y=>y.rev),backgroundColor:yd.map((_,i)=>yc[i%yc.length])}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>fmt(v)}}},plugins:{tooltip:{callbacks:{label:ctx=>fmtF(ctx.parsed.y)}}}}});

  // === TAB 3: MONTH OVER MONTH ===
  let t3='<div class="card" style="margin-bottom:18px"><div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><span style="font-size:12px;font-weight:600;color:var(--navy)">Compare:</span><select id="mom-y1" onchange="renderMoMComparison()" style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:12px">';
  yrs.forEach((y,i)=>{t3+='<option value="'+y+'"'+(i===yrs.length-2?' selected':'')+'>'+y+'</option>';});
  t3+='</select><span style="font-size:12px;color:var(--gray)">vs</span><select id="mom-y2" onchange="renderMoMComparison()" style="padding:5px 8px;border-radius:4px;border:1px solid #ccc;font-size:12px">';
  yrs.forEach((y,i)=>{t3+='<option value="'+y+'"'+(i===yrs.length-1?' selected':'')+'>'+y+'</option>';});
  t3+='</select></div></div>';
  t3+='<div id="mom-kpis"></div><div id="mom-chart" class="card"><h3>Monthly Revenue Comparison</h3><canvas id="c-mom-compare"></canvas></div>';
  t3+='<div id="mom-table" class="card"></div>';
  document.getElementById("tab-3").innerHTML=t3;
  window._allDataForMoM=allData;
  renderMoMComparison();

  // === TAB 4: REPS ===
  const tot=d.reduce((a,x)=>a+x.ev,0);
  const rps=[...new Set(d.map(x=>x.mc).filter(v=>v&&v!=="Unassigned"))];
  const rd=rps.map(rep=>{const r=d.filter(x=>x.mc===rep);return{name:rep,rev:r.reduce((a,x)=>a+x.ev,0),re:r.filter(x=>x.sc==="realized").reduce((a,x)=>a+x.ev,0),co:r.filter(x=>x.sc==="confirmed").reduce((a,x)=>a+x.ev,0),pr:r.filter(x=>x.sc==="preliminary").reduce((a,x)=>a+x.ev,0),n:r.length};}).sort((a,b)=>b.rev-a.rev);
  const rc=["#0A2636","#D23931","#2E8B57","#E8A317","#A2A2A2","#6B4C9A","#2196F3"];
  let t4='<div class="kpi-row">'+kpiHTML("Top Performer",rd[0]?rd[0].name.split(",")[0]:"\u2014",rd[0]?fmtF(rd[0].rev):"","var(--navy)")+kpiHTML("Reps",rps.length+"","","var(--grn)")+kpiHTML("Avg/Rep",fmt(rps.length?tot/rps.length:0),"","var(--amb)")+'</div>';
  t4+='<div class="chart-row"><div class="card wide"><h3>Revenue by Rep</h3><canvas id="c-rep-bar"></canvas></div><div class="card narrow"><h3>Share</h3><canvas id="c-rep-pie"></canvas></div></div>';
  const rpRows=rd.map(r=>"<tr><td style='font-weight:600'>"+r.name+"</td><td style='font-weight:700'>"+fmtF(r.rev)+"</td><td>"+fmtF(r.re)+"</td><td>"+fmtF(r.co)+"</td><td>"+fmtF(r.pr)+"</td><td>"+r.n+"</td></tr>");
  t4+='<div class="card"><h3>Rep Detail</h3>'+tableHTML(["Sales Rep","Total","Realized","Confirmed","Pipeline","#"],rpRows)+'</div>';
  document.getElementById("tab-4").innerHTML=t4;
  destroyChart("c-rep-bar");
  charts["c-rep-bar"]=new Chart(document.getElementById("c-rep-bar"),{type:"bar",data:{labels:rd.map(r=>r.name.length>20?r.name.substring(0,20)+"...":r.name),datasets:[{label:"Realized",data:rd.map(r=>r.re),backgroundColor:"#2E8B57"},{label:"Confirmed",data:rd.map(r=>r.co),backgroundColor:"#E8A317"},{label:"Preliminary",data:rd.map(r=>r.pr),backgroundColor:"rgba(210,57,49,0.5)"}]},options:{indexAxis:"y",responsive:true,scales:{x:{stacked:true,ticks:{callback:v=>fmt(v)}},y:{stacked:true}},plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+": "+fmtF(ctx.parsed.x)}}}}});
  destroyChart("c-rep-pie");
  charts["c-rep-pie"]=new Chart(document.getElementById("c-rep-pie"),{type:"pie",data:{labels:rd.map(r=>r.name.split(",")[0].split(" ")[0]),datasets:[{data:rd.map(r=>r.rev),backgroundColor:rd.map((_,i)=>rc[i%rc.length])}]},options:{responsive:true,plugins:{tooltip:{callbacks:{label:ctx=>ctx.label+": "+fmtF(ctx.parsed)}}}}});

  // === TAB 5: DESTINATIONS ===
  const allD={};d.forEach(x=>{x.dest.split(",").map(s=>s.trim()).filter(Boolean).forEach(ds=>{if(!allD[ds])allD[ds]={name:ds,rev:0,n:0,re:0,co:0,pr:0};allD[ds].rev+=x.ev;allD[ds].n++;if(x.sc==="realized")allD[ds].re+=x.ev;else if(x.sc==="confirmed")allD[ds].co+=x.ev;else if(x.sc==="preliminary")allD[ds].pr+=x.ev;});});
  const dd=Object.values(allD).sort((a,b)=>b.rev-a.rev);
  let t5='<div class="kpi-row">'+kpiHTML("Top Destination",dd[0]?dd[0].name:"\u2014",dd[0]?fmtF(dd[0].rev):"","var(--navy)")+kpiHTML("Destinations",dd.length+"","","var(--grn)")+kpiHTML("Avg/Dest",fmt(dd.length?dd.reduce((a,x)=>a+x.rev,0)/dd.length:0),"","var(--amb)")+'</div>';
  t5+='<div class="chart-row"><div class="card wide"><h3>Revenue by Destination</h3><canvas id="c-dest-bar"></canvas></div><div class="card narrow"><h3>Share</h3><canvas id="c-dest-pie"></canvas></div></div>';
  const dRows=dd.map(x=>"<tr><td style='font-weight:600'>"+x.name+"</td><td style='font-weight:700'>"+fmtF(x.rev)+"</td><td>"+fmtF(x.re)+"</td><td>"+fmtF(x.co)+"</td><td>"+fmtF(x.pr)+"</td><td>"+x.n+"</td></tr>");
  t5+='<div class="card"><h3>Destination Detail</h3>'+tableHTML(["Destination","Total","Realized","Confirmed","Pipeline","#"],dRows)+'</div>';
  document.getElementById("tab-5").innerHTML=t5;
  destroyChart("c-dest-bar");
  charts["c-dest-bar"]=new Chart(document.getElementById("c-dest-bar"),{type:"bar",data:{labels:dd.map(x=>x.name),datasets:[{label:"Revenue",data:dd.map(x=>x.rev),backgroundColor:dd.map((_,i)=>["#0A2636","#D23931","#2E8B57","#E8A317","#6B4C9A","#2196F3","#A2A2A2"][i%7])}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>fmt(v)}}},plugins:{tooltip:{callbacks:{label:ctx=>fmtF(ctx.parsed.y)}}}}});
  destroyChart("c-dest-pie");
  charts["c-dest-pie"]=new Chart(document.getElementById("c-dest-pie"),{type:"pie",data:{labels:dd.map(x=>x.name),datasets:[{data:dd.map(x=>x.rev),backgroundColor:dd.map((_,i)=>["#0A2636","#D23931","#2E8B57","#E8A317","#6B4C9A","#2196F3","#A2A2A2"][i%7])}]},options:{responsive:true,plugins:{tooltip:{callbacks:{label:ctx=>ctx.label+": "+fmtF(ctx.parsed)}}}}});
}

// === YOY COMPARISON ===
function renderYoYComparison(){
  const y1=parseInt(document.getElementById("yoy-y1")?.value);
  const y2=parseInt(document.getElementById("yoy-y2")?.value);
  if(!y1||!y2)return;
  const ad=window._allDataForYoY||allData;
  const d1=ad.filter(x=>x.yr===y1),d2=ad.filter(x=>x.yr===y2);
  const r1=d1.reduce((a,x)=>a+x.ev,0),r2=d2.reduce((a,x)=>a+x.ev,0);
  const diff=r2-r1,diffPct=r1>0?((diff/r1)*100).toFixed(1):0;

  document.getElementById("yoy-kpis").innerHTML='<div class="kpi-row">'+kpiHTML(y1+" Revenue",fmt(r1),d1.length+" programs","#0A2636")+kpiHTML(y2+" Revenue",fmt(r2),d2.length+" programs","#D23931")+kpiHTML("Difference",fmt(diff),(diff>=0?"+":"")+diffPct+"%",diff>=0?"var(--grn)":"var(--red)")+'</div>';

  const m1=MONTHS.map((_,i)=>d1.filter(x=>x.mo===i+1).reduce((a,x)=>a+x.ev,0));
  const m2=MONTHS.map((_,i)=>d2.filter(x=>x.mo===i+1).reduce((a,x)=>a+x.ev,0));
  destroyChart("c-yoy-compare");
  charts["c-yoy-compare"]=new Chart(document.getElementById("c-yoy-compare"),{type:"bar",data:{labels:MONTHS,datasets:[{label:y1+"",data:m1,backgroundColor:"rgba(10,38,54,0.7)"},{label:y2+"",data:m2,backgroundColor:"rgba(210,57,49,0.7)"}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>fmt(v)}}},plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+": "+fmtF(ctx.parsed.y)}}}}});

  // Status breakdown tables side by side
  document.getElementById("yoy-table").innerHTML='<h3>'+y1+' Breakdown</h3>'+statusBreakdownTable(ad,y1)+'<h3 style="margin-top:20px">'+y2+' Breakdown</h3>'+statusBreakdownTable(ad,y2);
}

// === MOM COMPARISON ===
function renderMoMComparison(){
  const y1=parseInt(document.getElementById("mom-y1")?.value);
  const y2=parseInt(document.getElementById("mom-y2")?.value);
  if(!y1||!y2)return;
  const ad=window._allDataForMoM||allData;
  const d1=ad.filter(x=>x.yr===y1),d2=ad.filter(x=>x.yr===y2);
  const r1=d1.reduce((a,x)=>a+x.ev,0),r2=d2.reduce((a,x)=>a+x.ev,0);

  // Peak months
  const m1d=MONTHS.map((_,i)=>d1.filter(x=>x.mo===i+1).reduce((a,x)=>a+x.ev,0));
  const m2d=MONTHS.map((_,i)=>d2.filter(x=>x.mo===i+1).reduce((a,x)=>a+x.ev,0));
  const pk1=m1d.indexOf(Math.max(...m1d)),pk2=m2d.indexOf(Math.max(...m2d));

  document.getElementById("mom-kpis").innerHTML='<div class="kpi-row">'+kpiHTML(y1+" Peak",MONTH_FULL[pk1],fmtF(m1d[pk1]),"#0A2636")+kpiHTML(y2+" Peak",MONTH_FULL[pk2],fmtF(m2d[pk2]),"#D23931")+kpiHTML(y1+" Avg/Mo",fmt(r1/12),y1+"","#0A2636")+kpiHTML(y2+" Avg/Mo",fmt(r2/12),y2+"","#D23931")+'</div>';

  destroyChart("c-mom-compare");
  charts["c-mom-compare"]=new Chart(document.getElementById("c-mom-compare"),{type:"bar",data:{labels:MONTHS,datasets:[{label:y1+"",data:m1d,backgroundColor:"rgba(10,38,54,0.7)"},{label:y2+"",data:m2d,backgroundColor:"rgba(210,57,49,0.7)"}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>fmt(v)}}},plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+": "+fmtF(ctx.parsed.y)}}}}});

  // Status breakdown tables
  document.getElementById("mom-table").innerHTML='<h3>'+y1+' Monthly Status Breakdown</h3>'+statusBreakdownTable(ad,y1)+'<h3 style="margin-top:20px">'+y2+' Monthly Status Breakdown</h3>'+statusBreakdownTable(ad,y2);
}

// === PASSWORD GATE ===
const ACCESS_CODE = "cantrav2026";

// === HARDCODED GOOGLE SHEETS URL ===
const GSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRsUh22Nyxr7WBJv1FsvT2dWrKecDK907MCe1zyyYJcgo6WoDxB3TlbTW9sX90no9uSjI-co8CFVlP1/pub?output=csv";

function initDashboard(){
  if(GSHEET_URL){
    loadFromGS(GSHEET_URL);
    const urlInput=document.getElementById("gs-url");
    if(urlInput)urlInput.value=GSHEET_URL;
  } else {
    renderAllTabs();
  }
}

(function(){
  // Check if already authenticated this session
  try{ if(sessionStorage.getItem("cantrav_auth")==="1"){ initDashboard(); return; } }catch(e){}
  
  // Show password gate
  var overlay = document.createElement("div");
  overlay.id = "pw-gate";
  overlay.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:#0A2636;display:flex;align-items:center;justify-content:center;z-index:99999;";
  
  var box = document.createElement("div");
  box.style.cssText = "background:#fff;border-radius:16px;padding:44px 40px;max-width:420px;width:90%;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.3);";
  
  box.innerHTML = '<h2 style="font-family:Georgia,serif;color:#0A2636;font-size:19px;margin-bottom:6px">Cantrav Financial Dashboard</h2>'
    + '<p style="font-size:12px;color:#A2A2A2;margin-bottom:22px">Enter the access code to continue</p>'
    + '<p id="pw-err" style="color:#D23931;font-size:12px;margin-bottom:10px;display:none">Incorrect password. Please try again.</p>'
    + '<input type="password" id="pw-input" placeholder="Access Code" style="width:100%;padding:12px 16px;border:1px solid #ddd;border-radius:8px;font-size:14px;text-align:center;margin-bottom:14px;letter-spacing:1px;outline:none;box-sizing:border-box;">'
    + '<button id="pw-btn" style="width:100%;padding:13px;border:none;border-radius:8px;background:#D23931;color:#fff;font-size:14px;font-weight:600;cursor:pointer;">Enter Dashboard</button>';
  
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  
  var inp = document.getElementById("pw-input");
  var btn = document.getElementById("pw-btn");
  var err = document.getElementById("pw-err");
  
  function tryLogin(){
    if(inp.value === ACCESS_CODE){
      overlay.remove();
      try{ sessionStorage.setItem("cantrav_auth","1"); }catch(e){}
      initDashboard();
    } else {
      err.style.display = "block";
      inp.value = "";
      inp.focus();
    }
  }
  
  btn.addEventListener("click", tryLogin);
  inp.addEventListener("keydown", function(e){ if(e.key==="Enter") tryLogin(); });
  inp.focus();
})();
</script>
</body>
</html>
